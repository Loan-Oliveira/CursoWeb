USE [ics]
GO

/****** Object:  StoredProcedure [dbo].[SP_WEB_MAIS_VANT_PARC]    Script Date: 27/03/2024 11:14:53 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[SP_WEB_MAIS_VANT_PARC]
   @NR_ID INT = 0,
   @TITULO VARCHAR(200) = NULL,
   @DESCRICAO VARCHAR(5000) = NULL,
   @DESCONTO VARCHAR(20)= NULL,
   @IMAGEM VARCHAR(500)= NULL,
   @NR_ID_CAT INT = 0,
   @COLABORADOR CHAR(1) = NULL,
   @BENEFICIARIO CHAR(1) = NULL,
   @TP_OP INT = 0

AS BEGIN
	
	/**** CONSULTA ****/
	IF @TP_OP = 0
	BEGIN
		SELECT T837.T837_NR_ID,
		T837.T837_CA_NOME_EMPRESA,
		T837.T837_CA_DESCRICAO,
		T837.T837_CA_DESCONTO,
		T837.T837_CA_LINK_IMAGEM,
		T837.T837_CA_BENEFICIARIO,
		T837.T837_CA_COLABORADOR,
		T837.T836_NR_ID,
		T836.T836_CA_NOME 
		FROM T837_MAIS_VANT_PARC T837
		LEFT JOIN T836_MAIS_VANT_CAT T836
			ON T836.T836_NR_ID = T837.T836_NR_ID
		WHERE (1=1)
			AND ((@NR_ID_CAT = 0) OR 
			(T837.T836_NR_ID = @NR_ID_CAT ))
	END
	
	/**** INCLUSAO ****/
	IF @TP_OP = 1
	BEGIN
		IF ((@TITULO = '') OR (@NR_ID_CAT = 0))
		BEGIN
			SELECT 1 AS 'CODERRO', 'CAMPOS NOME DA EMPRESA/TÍTULO E CATEGORIA SÃO OBRIGATÓRIOS' AS 'MSGERRO'
			RETURN
		END
		ELSE IF NOT EXISTS (SELECT T836_NR_ID FROM T836_MAIS_VANT_CAT WHERE T836_NR_ID = @NR_ID_CAT)
		BEGIN
			SELECT 2 AS 'CODERRO', 'CATEGORIA NÃO ENCONTRADA' AS 'MSGERRO'
			RETURN
		END
		ELSE
		BEGIN
			INSERT INTO T837_MAIS_VANT_PARC (T837_CA_NOME_EMPRESA, T837_CA_DESCRICAO, T837_CA_DESCONTO, T837_CA_LINK_IMAGEM, T836_NR_ID, T837_CA_COLABORADOR, T837_CA_BENEFICIARIO)
			VALUES (@TITULO, @DESCRICAO, @DESCONTO, @IMAGEM, @NR_ID_CAT, @COLABORADOR, @BENEFICIARIO)
		END
	END

	/**** EXCLUSÃO ****/
	IF @TP_OP = 2
	BEGIN
		IF @NR_ID = 0
		BEGIN
			SELECT 3 AS 'CODERRO', 'OBRIGATÓRIO INFORMAR O PARCEIRO' AS 'MSGERRO'
			RETURN
		END
		ELSE IF NOT EXISTS (SELECT T837_NR_ID FROM T837_MAIS_VANT_PARC WHERE T837_NR_ID = @NR_ID)
		BEGIN
			SELECT 4 AS 'CODERRO', 'PARCEIRO NÃO ENCONTRADO' AS 'MSGERRO'
			RETURN
		END
		ELSE 
		BEGIN
			DELETE FROM T837_MAIS_VANT_PARC WHERE T837_NR_ID = @NR_ID
		END
	END

	/**** ALTERAÇÃO ****/
	IF @TP_OP = 3
	BEGIN	
		IF @TITULO = ''
		BEGIN
			SELECT 5 AS 'CODERRO', 'NOME PARCEIRO NÃO INFORMADO' AS 'MSGERRO'
			RETURN
		END
		ELSE
		BEGIN
			UPDATE T837_MAIS_VANT_PARC SET	T837_CA_NOME_EMPRESA = @TITULO,
											T837_CA_DESCRICAO = @DESCRICAO,
											T837_CA_LINK_IMAGEM = @IMAGEM,
											T836_NR_ID = @NR_ID_CAT,
											T837_CA_COLABORADOR = @COLABORADOR,
											T837_CA_BENEFICIARIO = @BENEFICIARIO,
											T837_CA_DESCONTO = @DESCONTO
			WHERE T837_NR_ID = @NR_ID
		END
	END
		
END



GO


